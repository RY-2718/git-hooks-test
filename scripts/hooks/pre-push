#!/bin/sh

# ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ã®pushæ™‚ã«CHANGELOG.mdã«[Unreleased]ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒæ®‹ã£ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯ã—ã¾ã™

remote="$1"
url="$2"

echo "ğŸ·ï¸  Pre-push hook started"

while read local_ref local_oid remote_ref remote_oid
do
    # ã‚¿ã‚°ã®pushã‹ãƒã‚§ãƒƒã‚¯ (v[æ•°å­—]ã§å§‹ã¾ã‚‹ã‚¿ã‚°)
    if echo "$local_ref" | grep -q "refs/tags/v[0-9]"; then
        tag_name=$(echo "$local_ref" | sed 's|refs/tags/||')
        echo "ğŸ·ï¸  Release tag detected: $tag_name"

        # CHANGELOG.mdã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
        if [ ! -f "CHANGELOG.md" ]; then
            echo "âŒ Error: CHANGELOG.md not found!"
            exit 1
        fi

        # [Unreleased]ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ãªã„ã‹ãƒã‚§ãƒƒã‚¯
        if grep -q "^## \[Unreleased\]" CHANGELOG.md; then
            echo "âŒ Error: [Unreleased] section still exists in CHANGELOG.md!"
            echo "   Please update CHANGELOG.md before releasing $tag_name"
            echo ""
            echo "ğŸ’¡ Tip: Move content from [Unreleased] to [$tag_name] section"
            echo "   Example:"
            echo "   ## [Unreleased]"
            echo "   - Feature A"
            echo "   - Bug fix B"
            echo ""
            echo "   Change to:"
            echo "   ## [$tag_name] - $(date +%Y-%m-%d)"
            echo "   - Feature A"
            echo "   - Bug fix B"
            exit 1
        fi

        # ã‚¿ã‚°åã«å¯¾å¿œã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if ! grep -q "^## \[$tag_name\]" CHANGELOG.md; then
            echo "âš ï¸  Warning: [$tag_name] section not found in CHANGELOG.md"
            echo "   Consider adding a section for this release"
            exit 1
        fi

        echo "âœ… CHANGELOG.md validation passed for $tag_name"
    fi
done

exit 0
